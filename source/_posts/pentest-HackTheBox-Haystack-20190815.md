---
title: pentest HackTheBox Haystack 20190815
date: 2019-08-15 11:13:42
tags: [HackTheBox]
categories: [Network Security]
---

### 一、nmap扫描

![nmap](/sourcepictures/2019/08/15/1.png)

### 二、binwalk查找隐藏数据

![binwalk](/sourcepictures/2019/08/15/2.png)

### 三、strings查找字符串
![strings](/sourcepictures/2019/08/15/3.png)

最后一行base64加密

### 四、base64解密

![b64decode](/sourcepictures/2019/08/15/4.png)


```
la aguja en el pajar es "clave" (西班牙语)
翻译为英语：the needle in the haystack is "key"
```

### 五、 访问9200端口

9200端口是ElasticSearch，关于ElasticSearch命令用法可以参考[ElasticSearch Commands Cheat Sheet](https://www.bmc.com/blogs/elasticsearch-commands/)


```
1. delete index
Below the index is named samples.

curl -X DELETE 'http://localhost:9200/samples'

2. list all indexes
curl -X GET 'http://localhost:9200/_cat/indices?v'

3. list all docs in index
curl -X GET 'http://localhost:9200/sample/_search'

4. query using URL parameters
Here we use Lucene query format to write q=school:Harvard.

curl -X GET http://localhost:9200/samples/_search?q=school:Harvard

5. Query with JSON aka Elasticsearch Query DSL
You can query using parameters on the URL. But you can also use JSON, as shown in the next example. JSON would be easier to read and debug when you have a complex query than one giant string of URL parameters.

curl -XGET --header 'Content-Type: application/json' http://localhost:9200/samples/_search -d '{
      "query" : {
        "match" : { "school": "Harvard" }
    }
}'

6. list index mapping
All Elasticsearch fields are indexes. So this lists all fields and their types in an index.

curl -X GET http://localhost:9200/samples

7. Add Data
curl -XPUT --header 'Content-Type: application/json' http://localhost:9200/samples/_doc/1 -d '{
   "school" : "Harvard"			
}'

8. Update Doc
Here is how to add fields to an existing document. First we create a new one. Then we update it. 

curl -XPUT --header 'Content-Type: application/json' http://localhost:9200/samples/_doc/2 -d '
{
    "school": "Clemson"
}'

curl -XPOST --header 'Content-Type: application/json' http://localhost:9200/samples/_doc/2/_update -d '{
"doc" : {
               "students": 50000}
}'

 
9. backup index
curl -XPOST --header 'Content-Type: application/json' http://localhost:9200/_reindex -d '{
  "source": {
    "index": "samples"
  },
  "dest": {
    "index": "samples_backup"
  }
}'

 
10. Bulk load data in JSON format
export pwd="elastic:"

curl --user $pwd  -H 'Content-Type: application/x-ndjson' -XPOST 'https://58571402f5464923883e7be42a037917.eu-central-1.aws.cloud.es.io:9243/0/_bulk?pretty' --data-binary @<file>

11. Show cluster health
curl --user $pwd  -H 'Content-Type: application/json' -XGET https://58571402f5464923883e7be42a037917.eu-central-1.aws.cloud.es.io:9243/_cluster/health?pretty

12. Aggregation and Bucket Aggregation
For an nginx web server this produces web hit counts by user city:

curl -XGET --user $pwd --header 'Content-Type: application/json'  https://58571402f5464923883e7be42a037917.eu-central-1.aws.cloud.es.io:9243/logstash/_search?pretty -d '{
        "aggs": {
             "cityName": {
                    "terms": {
                     "field": "geoip.city_name.keyword",
                                "size": 50

        }
   }
  }
}
'

This expands that to product response code count by city in an nginx web server log

curl -XGET --user $pwd --header 'Content-Type: application/json'  https://58571402f5464923883e7be42a037917.eu-central-1.aws.cloud.es.io:9243/logstash/_search?pretty -d '{
        "aggs": {
          "city": {
                "terms": {
                        "field": "geoip.city_name.keyword"
                },
        "aggs": {
          "responses": {
                "terms": {
                     "field": "response"
                 }
           }
         }
      },
      "responses": {
                "terms": {
                     "field": "response"
                 }
        }
   }
}'
```


访问结果：
![elasticsearch1](/sourcepictures/2019/08/15/6.png)

![elasticsearch2](/sourcepictures/2019/08/15/7.png)

---
屌丝水平有限，卡在这里，等有时间再琢磨
---




